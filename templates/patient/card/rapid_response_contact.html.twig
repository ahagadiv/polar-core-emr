{% extends "patient/card/card_base.html.twig" %}

{% block content %}
<div class="text ml-2">
    {% if rapid_response_contacts is defined and rapid_response_contacts is not empty %}
        <div class="rapid-response-list">
            {% for contact in rapid_response_contacts %}
                <div class="rapid-response-item mb-3 p-2 border rounded" style="background: #f8f9fa;" data-contact-id="{{ contact.id }}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge badge-primary">{{ contact.category }}</span>
                            <small class="text-muted ml-2">{{ contact.updated_date|date('M j, Y') }}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge badge-success mr-2">ACTIVE</span>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editRapidResponseContact('{{ contact.id }}')" title="Edit Contact">
                                <i class="fa fa-pencil-alt"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger ml-1" onclick="deleteRapidResponseContact('{{ contact.id }}')" title="Delete Contact">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="contact-address mb-2">
                        <strong>{{ contact.address }}</strong>
                    </div>
                    
                    {% if contact.phone %}
                        <div class="contact-phone">
                            <i class="fa fa-phone text-success mr-2"></i>
                            <a href="tel:{{ contact.phone }}" class="text-decoration-none">
                                {{ contact.phone }}
                            </a>
                        </div>
                    {% endif %}
                    
                    {% if contact.notes %}
                        <div class="mt-1">
                            <small class="text-muted">
                                <strong>Notes:</strong> {{ contact.notes }}
                            </small>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-primary btn-sm" onclick="addNewContact()">
                <i class="fa fa-plus mr-1"></i>Add Rapid Response Contact
            </button>
        </div>
    {% else %}
        <div class="alert alert-info">
            <strong>ðŸš‘ No rapid response contacts recorded</strong>
            <p class="mb-0">No rapid response contact information has been documented for this patient.</p>
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-primary btn-sm" onclick="addNewContact()">
                <i class="fa fa-plus mr-1"></i>Add First Rapid Response Contact
            </button>
        </div>
    {% endif %}
</div>

<!-- Custom Rapid Response Contact Modal (No Bootstrap) -->
<div id="rapidResponseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
    <div style="position: relative; max-width: 600px; margin: 50px auto; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid #dee2e6;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h5 style="margin: 0; color: #333;">ðŸš‘ Rapid Response Contact</h5>
                <button type="button" id="closeModalBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
        </div>
        
        <form id="rapidResponseForm" method="post" action="">
            <div style="padding: 20px;">
                <input type="hidden" name="csrf_token_form" value="{{ csrf_token }}">
                <input type="hidden" name="action" value="save_rapid_response_contact">
                <input type="hidden" name="contact_id" id="contact_id" value="">

                <!-- Category Selection -->
                <div style="margin-bottom: 15px;">
                    <label for="category" style="display: block; margin-bottom: 5px; font-weight: bold;">Category *</label>
                    <select name="category" id="category" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                        <option value="">Select Category</option>
                        <option value="Home">Home</option>
                        <option value="Clinic">Clinic</option>
                        <option value="Nursing Home">Nursing Home</option>
                        <option value="LTACH">LTACH</option>
                        <option value="SNF">SNF</option>
                        <option value="Hospital">Hospital</option>
                    </select>
                </div>

                <!-- Address -->
                <div style="margin-bottom: 15px;">
                    <label for="address" style="display: block; margin-bottom: 5px; font-weight: bold;">Address *</label>
                    <textarea name="address" id="address" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;" rows="3" placeholder="Enter full address including street, city, state, zip" required></textarea>
                </div>

                <!-- Phone -->
                <div style="margin-bottom: 15px;">
                    <label for="phone" style="display: block; margin-bottom: 5px; font-weight: bold;">Phone Number</label>
                    <input type="tel" name="phone" id="phone" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="(555) 123-4567">
                </div>

                <!-- Notes -->
                <div style="margin-bottom: 15px;">
                    <label for="notes" style="display: block; margin-bottom: 5px; font-weight: bold;">Notes</label>
                    <textarea name="notes" id="notes" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;" rows="2" placeholder="Additional notes or special instructions"></textarea>
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid #dee2e6; text-align: right;">
                <button type="button" id="cancelBtn" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ccc; background: #f8f9fa; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button type="submit" style="padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">
                    ðŸ’¾ Save Contact
                </button>
            </div>
        </form>
    </div>
</div>

<script>
$(document).ready(function() {
    // Simple modal show/hide functions (no Bootstrap)
    function showModal() {
        $('#rapidResponseModal').show();
        $('body').css('overflow', 'hidden'); // Prevent background scrolling
    }
    
    function hideModal() {
        $('#rapidResponseModal').hide();
        $('body').css('overflow', ''); // Restore scrolling
    }
    
    // Handle close button clicks
    $('#closeModalBtn, #cancelBtn').click(function() {
        hideModal();
    });
    
    // Handle clicking outside modal to close
    $('#rapidResponseModal').click(function(e) {
        if (e.target === this) {
            hideModal();
        }
    });
    
    // Handle ESC key to close modal
    $(document).keydown(function(e) {
        if (e.keyCode === 27) { // ESC key
            hideModal();
        }
    });
    
    // Handle form submission
    $('#rapidResponseForm').on('submit', function(e) {
        e.preventDefault();

        var formData = $(this).serialize();
        console.log('Submitting form data:', formData);

        $.ajax({
            url: '{{ btnLink }}',
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
                console.log('Response received:', response);
                if (response.success) {
                    hideModal();
                    location.reload();
                } else {
                    alert('Error: ' + (response.error || 'Unknown error occurred'));
                }
            },
            error: function(xhr, status, error) {
                console.log('AJAX Error:', xhr.responseText, status, error);
                var errorMessage = 'Error saving rapid response contact. Please try again.';
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMessage = response.error;
                    }
                } catch (e) {
                    console.log('Could not parse error response');
                }
                alert(errorMessage);
            }
        });
    });
});

// Global functions for edit and delete
function editRapidResponseContact(contactId) {
    console.log('Edit function called with contactId:', contactId);
    
    // Load contact data and populate modal
    $.ajax({
        url: '{{ btnLink }}',
        type: 'GET',
        data: { action: 'get_rapid_response_contact', contact_id: contactId },
        dataType: 'json',
        success: function(response) {
            console.log('Edit response received:', response);
            if (response.success) {
                var contact = response.data;
                $('#contact_id').val(contact.id);
                $('#category').val(contact.category);
                $('#address').val(contact.address);
                $('#phone').val(contact.phone);
                $('#notes').val(contact.notes);
                
                // Show modal using simple method (no Bootstrap)
                $('#rapidResponseModal').show();
                $('body').css('overflow', 'hidden');
            } else {
                console.error('Edit failed:', response.error);
                alert('Error: ' + (response.error || 'Failed to load contact data'));
            }
        },
        error: function(xhr, status, error) {
            console.error('Edit AJAX Error:', xhr.responseText, status, error);
            alert('Error loading contact data. Please try again.');
        }
    });
}

function deleteRapidResponseContact(contactId) {
    if (confirm('Are you sure you want to delete this rapid response contact?')) {
        $.ajax({
            url: '{{ btnLink }}',
            type: 'POST',
            data: {
                action: 'delete_rapid_response_contact',
                contact_id: contactId,
                csrf_token_form: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (response.error || 'Unknown error occurred'));
                }
            },
            error: function(xhr, status, error) {
                console.log('AJAX Error:', xhr.responseText, status, error);
                var errorMessage = 'Error deleting rapid response contact. Please try again.';
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMessage = response.error;
                    }
                } catch (e) {
                    console.log('Could not parse error response');
                }
                alert(errorMessage);
            }
        });
    }
}

function addNewContact() {
    console.log('Add new contact function called');
    
    // Clear the form for adding a new contact
    $('#contact_id').val('');
    $('#category').val('');
    $('#address').val('');
    $('#phone').val('');
    $('#notes').val('');
    
    // Show modal using simple method (no Bootstrap)
    $('#rapidResponseModal').show();
    $('body').css('overflow', 'hidden');
}

function clearForm() {
    // Clear the form for adding a new contact
    $('#contact_id').val('');
    $('#category').val('');
    $('#address').val('');
    $('#phone').val('');
    $('#notes').val('');
}
</script>
{% endblock %}
