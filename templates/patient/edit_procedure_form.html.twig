<!DOCTYPE html>
<html>
<head>
    <title>Edit Procedure - Patient ID: {{ pid }}</title>
    <link rel="stylesheet" href="{{ webroot }}/public/themes/style_cobalt_blue.css?v=81" />
    <link rel="stylesheet" href="{{ webroot }}/public/themes/tabs_style_compact.css?v=81" />
    <script src="{{ webroot }}/public/assets/jquery/dist/jquery.min.js?v=81"></script>
    <script src="{{ webroot }}/public/assets/bootstrap/dist/js/bootstrap.bundle.min.js?v=81"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f2f5; }
        .form-container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        .form-header { border-bottom: 1px solid #dee2e6; padding-bottom: 15px; margin-bottom: 25px; }
        .form-header h2 { margin: 0; font-size: 1.8em; color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-label { font-weight: bold; color: #555; display: block; margin-bottom: 8px; }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        .btn-submit {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }
        .btn-submit:hover {
            background-color: #218838;
        }
        .btn-cancel {
            background-color: #6c757d;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }
        .btn-cancel:hover {
            background-color: #5a6268;
        }
        .input-group {
            display: flex;
            width: 100%;
        }
        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: 0;
        }
        .common-cpt-codes {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .common-cpt-codes h4 {
            color: #333;
            margin-bottom: 15px;
        }
        .common-cpt-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .common-cpt-item {
            background-color: #e9f5ff;
            color: #0056b3;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #b3d9ff;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
        }
        .common-cpt-item:hover {
            background-color: #d0e9ff;
            border-color: #80bdff;
        }
        .common-cpt-item .cpt-code {
            font-weight: bold;
            font-size: 1.1em;
            color: #007bff;
            margin-bottom: 4px;
        }
        .common-cpt-item .cpt-desc {
            font-size: 0.9em;
            color: #333;
            line-height: 1.3;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <h2>Edit Procedure for Patient ID: {{ pid }}</h2>
        </div>
        <form id="editProcedureForm" action="{{ webroot }}/controller.php?procedure&save&id={{ pid }}" method="POST">
            <input type="hidden" name="csrf_token_form" value="{{ csrf_token_form }}">
            <input type="hidden" name="pid" value="{{ pid }}">
            <input type="hidden" name="procedure_id" value="{{ procedure.id }}">

            <div class="form-row">
                <div class="form-group">
                    <label for="procedureDate" class="form-label">Procedure Date:</label>
                    <input type="datetime-local" id="procedureDate" name="date" class="form-control" value="{{ procedure.procedure_date|date('Y-m-d\\TH:i') }}" required>
                </div>
                <div class="form-group">
                    <label for="status" class="form-label">Status:</label>
                    <select id="status" name="status" class="form-control" required>
                        <option value="ACTIVE" {% if procedure.status == 'ACTIVE' %}selected{% endif %}>Active</option>
                        <option value="COMPLETED" {% if procedure.status == 'COMPLETED' %}selected{% endif %}>Completed</option>
                        <option value="CANCELLED" {% if procedure.status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="cptCode" class="form-label">CPT Code:</label>
                <div class="input-group">
                    <input type="text" id="cptCode" name="cpt_code" class="form-control" placeholder="e.g., 36569, A4215, 76937" value="{{ procedure.cpt_code }}" required onchange="lookupCPTCode()">
                    <button type="button" class="btn btn-outline-primary" onclick="searchCPTCodes()">Search CPT</button>
                </div>
            </div>

            <div class="form-group">
                <label for="description" class="form-label">Procedure Description:</label>
                <textarea id="description" name="description" class="form-control" rows="5" required>{{ procedure.procedure_description }}</textarea>
            </div>

            <div class="form-group">
                <label for="notes" class="form-label">Notes:</label>
                <textarea id="notes" name="notes" class="form-control" rows="3">{{ procedure.notes }}</textarea>
            </div>

            <div class="common-cpt-codes">
                <h4>Common CPT Codes:</h4>
                <div class="common-cpt-list">
                    <div class="common-cpt-item" data-code="93970" data-desc="Duplex scan of extremity veins; complete bilateral study">
                        <span class="cpt-code">93970</span>
                        <span class="cpt-desc">Duplex scan of extremity veins; complete bilateral study</span>
                    </div>
                    <div class="common-cpt-item" data-code="36561" data-desc="Insertion of tunneled centrally inserted central venous catheter, without subcutaneous port or pump; age 5 years or older">
                        <span class="cpt-code">36561</span>
                        <span class="cpt-desc">Insertion of tunneled centrally inserted central venous catheter, without subcutaneous port or pump; age 5 years or older</span>
                    </div>
                    <div class="common-cpt-item" data-code="36571" data-desc="Repair of tunneled or non-tunneled centrally inserted central venous catheter, without subcutaneous port or pump, any age, including fluoroscopic guidance, when performed">
                        <span class="cpt-code">36571</span>
                        <span class="cpt-desc">Repair of tunneled or non-tunneled centrally inserted central venous catheter, without subcutaneous port or pump, any age, including fluoroscopic guidance, when performed</span>
                    </div>
                    <div class="common-cpt-item" data-code="76937" data-desc="Ultrasound guidance for vascular access requiring ultrasound evaluation of potential access sites, documentation of selected vessel patency, concurrent realtime ultrasound visualization of vascular needle entry, with permanent recording and reporting">
                        <span class="cpt-code">76937</span>
                        <span class="cpt-desc">Ultrasound guidance for vascular access requiring ultrasound evaluation of potential access sites, documentation of selected vessel patency, concurrent realtime ultrasound visualization of vascular needle entry, with permanent recording and reporting</span>
                    </div>
                    <div class="common-cpt-item" data-code="99213" data-desc="Office or other outpatient visit for the evaluation and management of an established patient, which requires at least 2 of 3 medical decision making components">
                        <span class="cpt-code">99213</span>
                        <span class="cpt-desc">Office or other outpatient visit for the evaluation and management of an established patient, which requires at least 2 of 3 medical decision making components</span>
                    </div>
                    <div class="common-cpt-item" data-code="A4301" data-desc="BARD MIDLINE KIT">
                        <span class="cpt-code">A4301</span>
                        <span class="cpt-desc">BARD MIDLINE KIT</span>
                    </div>
                    <div class="common-cpt-item" data-code="36569" data-desc="Insertion of peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, without guidance, age 5 years or older">
                        <span class="cpt-code">36569</span>
                        <span class="cpt-desc">Insertion of peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, without guidance, age 5 years or older</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px; text-align: right;">
                <button type="submit" class="btn-submit">Update Procedure</button>
                <button type="button" class="btn-cancel" onclick="history.back()">Cancel</button>
            </div>
        </form>
    </div>

    <script>
        // Common CPT codes data
        const commonCptCodes = {
            "93970": "Duplex scan of extremity veins; complete bilateral study",
            "36561": "Insertion of tunneled centrally inserted central venous catheter, without subcutaneous port or pump; age 5 years or older",
            "36571": "Repair of tunneled or non-tunneled centrally inserted central venous catheter, without subcutaneous port or pump, any age, including fluoroscopic guidance, when performed",
            "76937": "Ultrasound guidance for vascular access requiring ultrasound evaluation of potential access sites, documentation of selected vessel patency, concurrent realtime ultrasound visualization of vascular needle entry, with permanent recording and reporting",
            "99213": "Office or other outpatient visit for the evaluation and management of an established patient, which requires at least 2 of 3 medical decision making components",
            "A4301": "BARD MIDLINE KIT",
            "36569": "Insertion of peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, without guidance, age 5 years or older"
        };

        // Handle click on common CPT codes
        document.querySelectorAll('.common-cpt-item').forEach(item => {
            item.addEventListener('click', function() {
                const code = this.dataset.code;
                const desc = this.dataset.desc;
                document.getElementById('cptCode').value = code;
                document.getElementById('description').value = desc;
            });
        });

        // CPT Code lookup function
        function lookupCPTCode() {
            const code = document.getElementById('cptCode').value.trim();
            if (code && commonCptCodes[code]) {
                document.getElementById('description').value = commonCptCodes[code];
            }
        }

        // Search CPT Codes function
        function searchCPTCodes() {
            console.log('Search CPT button clicked');
            
            // Create and show modal
            showCPTSearchModal();
        }

        function showCPTSearchModal() {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'cptModalOverlay';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                width: 90%;
                max-width: 1000px;
                height: 80%;
                max-height: 600px;
                display: flex;
                flex-direction: column;
            `;

            // Modal header
            const modalHeader = document.createElement('div');
            modalHeader.style.cssText = `
                background: #007bff;
                color: white;
                padding: 15px 20px;
                border-radius: 8px 8px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            modalHeader.innerHTML = `
                <h3 style="margin: 0; font-size: 1.5em;">Search CPT Codes</h3>
                <button onclick="closeCPTSearchModal()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">&times;</button>
            `;

            // Modal body
            const modalBody = document.createElement('div');
            modalBody.style.cssText = `
                padding: 20px;
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            `;

            // Search input
            const searchContainer = document.createElement('div');
            searchContainer.style.cssText = 'margin-bottom: 20px;';
            searchContainer.innerHTML = `
                <input type="text" id="cptSearch" placeholder="Search CPT codes by code or description..." 
                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1em;">
            `;

            // Results container
            const resultsContainer = document.createElement('div');
            resultsContainer.id = 'cptSearchResults';
            resultsContainer.style.cssText = `
                flex: 1;
                overflow-y: auto;
                border: 1px solid #dee2e6;
                border-radius: 4px;
            `;

            modalBody.appendChild(searchContainer);
            modalBody.appendChild(resultsContainer);
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Initialize the modal
            initializeCPTModal();
        }

        function closeCPTSearchModal() {
            const modal = document.getElementById('cptModalOverlay');
            if (modal) {
                modal.remove();
            }
        }

        function initializeCPTModal() {
            // Common CPT codes data
            const cptCodes = {
                "93970": "Duplex scan of extremity veins; complete bilateral study",
                "36561": "Insertion of tunneled centrally inserted central venous catheter, without subcutaneous port or pump; age 5 years or older",
                "36571": "Repair of tunneled or non-tunneled centrally inserted central venous catheter, without subcutaneous port or pump, any age, including fluoroscopic guidance, when performed",
                "76937": "Ultrasound guidance for vascular access requiring ultrasound evaluation of potential access sites, documentation of selected vessel patency, concurrent realtime ultrasound visualization of vascular needle entry, with permanent recording and reporting",
                "99213": "Office or other outpatient visit for the evaluation and management of an established patient, which requires at least 2 of 3 medical decision making components",
                "A4301": "BARD MIDLINE KIT",
                "36569": "Insertion of peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, without guidance, age 5 years or older",
                "A4215": "BardPowerPICC + 3CG",
                "A4216": "BardPowerPICC Solo",
                "A4217": "BardPowerPICC Solo2",
                "A4218": "BardPowerPICC Max",
                "36410": "Venipuncture, age 3 years or older, necessitating the skill of a physician or other qualified health care professional, for diagnostic or therapeutic purposes (specify reason)",
                "36568": "Insertion of peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, without imaging guidance; younger than 5 years",
                "36572": "Insertion of peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, with imaging guidance; younger than 5 years",
                "36573": "Insertion of peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, with imaging guidance; central venous access device insertion",
                "36584": "Replacement, complete, of a peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, through same venous access",
                "36585": "Replacement, complete, of a peripherally inserted central venous catheter (PICC), without subcutaneous port or pump, through new venous access",
                "36589": "Removal of peripherally inserted central venous catheter (PICC), without subcutaneous port or pump"
            };

            function displayAllCPTCodes() {
                const resultsContainer = document.getElementById('cptSearchResults');
                let html = '';
                
                // Add Common CPT Codes section first
                html += '<div style="background: #e9f5ff; padding: 15px; margin-bottom: 15px; border-radius: 5px; border-left: 4px solid #007bff;">';
                html += '<h4 style="margin: 0 0 10px 0; color: #007bff;">Common CPT Codes</h4>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                
                const commonCodes = ['93970', '36561', '36571', '76937', '99213', 'A4301', '36569'];
                commonCodes.forEach(code => {
                    if (cptCodes[code]) {
                        html += `<span onclick="selectCPTCodeFromModal('${code}', '${cptCodes[code].replace(/'/g, "\\'")}')" style="background: #007bff; color: white; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; display: inline-block; margin: 2px;">${code}</span>`;
                    }
                });
                
                html += '</div>';
                html += '</div>';
                
                // Add all CPT codes
                html += '<div style="border-top: 1px solid #dee2e6; padding-top: 15px;">';
                html += '<h4 style="margin: 0 0 15px 0; color: #333;">All CPT Codes</h4>';
                
                for (const [code, description] of Object.entries(cptCodes)) {
                    html += `
                        <div onclick="selectCPTCodeFromModal('${code}', '${description.replace(/'/g, "\\'")}')" style="padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;">
                            <div style="font-weight: bold; color: #007bff; font-size: 1.1em;">${code}</div>
                            <div style="color: #333; margin-top: 5px; line-height: 1.4;">${description}</div>
                        </div>
                    `;
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
            }

            function searchCPTCodesInModal() {
                const searchTerm = document.getElementById('cptSearch').value.toLowerCase().trim();
                const resultsContainer = document.getElementById('cptSearchResults');
                
                if (!searchTerm) {
                    displayAllCPTCodes();
                    return;
                }

                const matchingCodes = [];
                for (const [code, description] of Object.entries(cptCodes)) {
                    if (code.toLowerCase().includes(searchTerm) || description.toLowerCase().includes(searchTerm)) {
                        matchingCodes.push({ code, description });
                    }
                }

                if (matchingCodes.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">No CPT codes found matching your search</div>';
                    return;
                }

                let html = '';
                matchingCodes.forEach(item => {
                    html += `
                        <div onclick="selectCPTCodeFromModal('${item.code}', '${item.description.replace(/'/g, "\\'")}')" style="padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;">
                            <div style="font-weight: bold; color: #007bff; font-size: 1.1em;">${item.code}</div>
                            <div style="color: #333; margin-top: 5px; line-height: 1.4;">${item.description}</div>
                        </div>
                    `;
                });
                resultsContainer.innerHTML = html;
            }

            // Set up event listeners
            document.getElementById('cptSearch').addEventListener('input', searchCPTCodesInModal);
            
            // Pre-populate with all codes
            displayAllCPTCodes();
        }

        function selectCPTCodeFromModal(code, description) {
            document.getElementById('cptCode').value = code;
            document.getElementById('description').value = description;
            closeCPTSearchModal();
        }
        
        // Function to handle CPT code selection from dialog
        function setCPTCode(code, description) {
            console.log('Setting CPT code:', code, description);
            try {
                setTimeout(function() {
                    var codeField = document.getElementById('cptCode');
                    var descField = document.getElementById('description');
                    
                    if (codeField) {
                        codeField.value = code;
                        codeField.style.backgroundColor = '#d4edda';
                        setTimeout(function() {
                            codeField.style.backgroundColor = '';
                        }, 1000);
                        codeField.dispatchEvent(new Event('change'));
                    }
                    
                    if (descField) {
                        descField.value = description;
                        descField.style.backgroundColor = '#d4edda';
                        setTimeout(function() {
                            descField.style.backgroundColor = '';
                        }, 1000);
                    }
                }, 100);
            } catch (error) {
                console.error('Error setting CPT code:', error);
            }
        }
        
        // Placeholder functions for compatibility
        function set_related() {}
        function set_related_target() {}
    </script>
</body>
</html>
